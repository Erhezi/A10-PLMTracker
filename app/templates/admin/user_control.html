{% extends "base.html" %}

{% block content %}
<h1 class="h4 fw-semibold mb-3">Admin User Control</h1>
<p class="text-muted small mb-4">Manage application access and roles for each user.</p>

<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0 user-control-table">
                <thead class="table-light text-muted">
                    <tr>
                        <th scope="col" class="text-uppercase small fw-semibold">Email</th>
                        <th scope="col" class="text-uppercase small fw-semibold">Role</th>
                        <th scope="col" class="text-uppercase small fw-semibold">Access</th>
                        {% if current_user.user_role == 'admin' and current_user.is_active %}
                        <th scope="col" class="text-uppercase small fw-semibold text-center">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td class="fw-semibold">{{ user.email }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('admin.update_user_role', user_email=user.email) }}">
                                <select class="form-select form-select-sm user-control-dropdown" name="user_role">
                                    <option value="admin" {% if user.user_role == 'admin' %}selected{% endif %}>Admin</option>
                                    <option value="user" {% if user.user_role == 'user' %}selected{% endif %}>User</option>
                                    <option value="view-only" {% if user.user_role == 'view-only' %}selected{% endif %}>View-Only</option>
                                </select>
                            </form>
                        </td>
                        <td class="fw-semibold text-uppercase small">{{ 'ACTIVE' if user.is_active else 'PENDING' }}</td>
                        {% if current_user.user_role == 'admin' and current_user.is_active %}
                        <td class="text-center">
                            <div class="d-inline-flex flex-wrap gap-2 justify-content-center">
                                <button type="button" class="btn btn-primary btn-sm update-btn" onclick="this.closest('tr').querySelector('form').submit()">Update Role</button>
                                {% if user.email != current_user.email %}
                                <form method="POST" action="{{ url_for('admin.approve_user_access', user_email=user.email) }}" class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm" {% if user.is_active %}disabled{% endif %}>Approve Access</button>
                                </form>
                                <form method="POST" action="{{ url_for('admin.disable_user', user_email=user.email) }}" class="d-inline">
                                    <button type="submit" class="btn btn-warning btn-sm" {% if not user.is_active %}disabled{% endif %}>Disable User</button>
                                </form>
                                <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="confirmDeletion('{{ user.email }}')">Delete</button>
                                {% endif %}
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function confirmDeletion(userEmail) {
    const confirmation = confirm(`Are you sure you want to delete the user with email: ${userEmail}?`);
    if (confirmation) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/delete-user/${userEmail}`;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

{% endblock %}
