{% extends 'base.html' %}
{% block title %}Collect Links — PLM Tracker{% endblock %}
{% block content %}
<h1 class="h4 fw-semibold mb-3">Item Relation Collection</h1>
<p class="text-muted small mb-4">Search and check source item(s) and replacement item(s), then Create Links. Sentinel: <span class="badge bg-secondary">NO REPLACEMENT</span>. Selecting a Contract Item whose Item Type is <code>Special</code> will add a placeholder replacement in the form <code>PENDING***&lt;mfg part number&gt;</code> and auto-stage it to <em>Pending Item Number</em>.</p>

<div class="row g-4">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex flex-column">
        <label class="form-label small text-uppercase">Items</label>
        <input id="item-search" name="q" class="form-control mb-2" placeholder="Search item (by 6-digit Infor Item Number)..." autocomplete="off"
               hx-get="/api/items/search" hx-trigger="keyup changed delay:300ms" hx-target="#item-results" hx-params="*" />
        <div class="small text-muted mb-2">Check boxes to select. Max {{ max_per_side }} per side.</div>
        <div id="item-selected" class="mb-2"></div>
        <div id="item-results" class="flex-grow-1 overflow-auto" style="max-height:300px"></div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body d-flex flex-column">
        <label class="form-label small text-uppercase">Replacement Items</label>
        <input id="repl-search" name="q" class="form-control mb-2" placeholder="Search replacement (by 6-digit Infor Item Number)..." autocomplete="off"
               hx-get="/api/items/search" hx-trigger="keyup changed delay:300ms" hx-target="#repl-results" hx-params="*" />
        <div class="d-flex gap-2 mb-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-sentinel="NO REPLACEMENT">Add NO REPLACEMENT</button>
          <button type="button" class="btn btn-sm btn-outline-primary" id="toggle-repl-mode" data-mode="item" title="Toggle search between Item and Contract Item">Mode: Item</button>
        </div>
        <div id="repl-selected" class="mb-2"></div>
        <div id="repl-results" class="flex-grow-1 overflow-auto" style="max-height:300px"></div>
      </div>
    </div>
  </div>
</div>

<div class="mt-4 d-flex align-items-end gap-3 flex-wrap">
  <div class="d-flex flex-column">
    <label class="form-label small mb-1 text-muted">Item PLM Stage</label>
    <div class="d-flex align-items-center gap-2">
      <span id="derived-stage" class="badge bg-info">&mdash;</span>
      <select id="stage-override" class="form-select form-select-sm w-auto" disabled>
        <option value="Pending Clinical Approval">Pending Clinical Approval</option>
        <option value="Tracking - Item Transition">Tracking - Item Transition</option>
      </select>
    </div>
  </div>
  <div class="d-flex flex-column">
    <label class="form-label small mb-1 text-muted">Expected Go Live Date</label>
    <input type="date" id="expected-go-live" class="form-control form-control-sm" min="{{ date_min }}" max="{{ date_max }}" />
  </div>
  <div class="d-flex flex-column">
    <label class="form-label small mb-1 text-muted">Wrike Task ID (10 digits)</label>
    <input type="text" pattern="\d{10}" maxlength="10" minlength="10" inputmode="numeric" id="wrike-id" class="form-control form-control-sm" placeholder="##########" />
  </div>
  <button id="create-links" class="btn btn-primary btn-sm" disabled>Create Links</button>
  <div id="batch-feedback" class="small"></div>
</div>

<div class="mt-4" id="created-results-wrapper" style="display:none;">
  <h2 class="h6 fw-semibold">Newly Created Links</h2>
  <div class="table-responsive border rounded shadow-sm">
    <table class="table table-sm table-hover align-middle mb-0" id="created-links-table">
      <thead class="table-light small">
        <tr>
          <th class="text-center" style="width:40px;">Remove</th>
          <th class="text-center">Item Group</th>
          <th>Item</th>
          <th>Replace Item</th>
          <th>Mfg Part #</th>
          <th>Mfg</th>
          <th style="min-width:220px;">Item Description</th>
          <th>Repl Mfg #</th>
          <th>Repl Mfg</th>
          <th style="min-width:220px;">Repl Description</th>
          <th class="text-center">Stage</th>
          <th style="min-width:110px;">Go Live</th>
          <th>Wrike ID</th>
          <th>CreateDT</th>
          <th>UpdateDT</th>
        </tr>
      </thead>
      <tbody class="small"></tbody>
    </table>
  </div>
</div>

<script id="allowed-stages-data" type="application/json">{{ allowed_stages|tojson }}</script>
<script id="batch-limits-data" type="application/json">{{ {"max_combinations": max_combinations, "max_per_side": max_per_side}|tojson }}</script>
<script>
(function(){
  const itemSelectedEl = document.getElementById('item-selected');
  const replSelectedEl = document.getElementById('repl-selected');
  const stageBadge = document.getElementById('derived-stage');
  const stageSelect = document.getElementById('stage-override');
  const createBtn = document.getElementById('create-links');
  const feedback = document.getElementById('batch-feedback');
  const goLiveInput = document.getElementById('expected-go-live');
  const wrikeInput = document.getElementById('wrike-id');
  const createdWrapper = document.getElementById('created-results-wrapper');
  const createdTableBody = document.querySelector('#created-links-table tbody');
  const itemSearch = document.getElementById('item-search');
  const replSearch = document.getElementById('repl-search');
  const replResults = document.getElementById('repl-results');
  const ORIGINAL_REPL_ENDPOINT = '/api/items/search';
  const CONTRACT_ITEM_ENDPOINT = '/api/contract-items/search';
  const SENTINELS = ['NO REPLACEMENT']; // PENDING handled dynamically as PENDING***<mfg_part>

  // Load batch limits from template data
  const batchLimitsData = document.getElementById('batch-limits-data');
  const batchLimits = batchLimitsData ? JSON.parse(batchLimitsData.textContent) : { max_combinations: 36, max_per_side: 6 };
  const MAX_PER_SIDE = batchLimits.max_per_side;
  const MAX_COMBINATIONS = batchLimits.max_combinations;

  let items = [];
  let repls = [];
  let pendingMeta = {}; // map PENDING***<part> -> { contract_id, mfg_part_num }

  function renderSelections(){
  const pill = (c,kind)=>`<span class='badge bg-secondary me-1 mb-1' data-code='${c}' data-kind='${kind}'>${c} <span class='ms-1' data-remove='x' style='cursor:pointer' aria-label='Remove'>&times;</span></span>`;
  itemSelectedEl.innerHTML = items.map(c=>pill(c,'item')).join('');
  replSelectedEl.innerHTML = repls.map(c=>pill(c,'repl')).join('');
    updateStage();
    createBtn.disabled = !(items.length && repls.length);
  }

  function updateStage(){
  let stage = '—';
  let locked = false;
  if(repls.length===1 && repls[0]==='NO REPLACEMENT'){ stage='Tracking - Discontinued'; locked=true; }
  else if(repls.length===1 && /^PENDING\*\*\*/.test(repls[0])){ stage='Pending Item Number'; locked=false; }
  else if(repls.length){ stage='Pending Clinical Approval'; }
    stageBadge.textContent = stage;
    stageBadge.className = 'badge ' + (locked? 'bg-secondary':'bg-info');
    stageSelect.disabled = locked || stage==='—';
  if(!locked && stage!=='—') stageSelect.value = 'Pending Clinical Approval';
  }

  function enforceLimits(){
    if(items.length > MAX_PER_SIDE) items = items.slice(0, MAX_PER_SIDE);
    if(repls.length > MAX_PER_SIDE) repls = repls.slice(0, MAX_PER_SIDE);
  }

  function updateReplSearchEndpoint(){
    const mode = document.getElementById('toggle-repl-mode')?.getAttribute('data-mode') || 'item';
    const was = replSearch.getAttribute('data-mode') || 'item';
    const toContract = mode === 'contract';
    const endpoint = toContract ? CONTRACT_ITEM_ENDPOINT : ORIGINAL_REPL_ENDPOINT;
    
    replSearch.setAttribute('data-mode', mode);
    replSearch.setAttribute('hx-get', endpoint);
    replSearch.placeholder = toContract ? 'Search contract item (by Mfg Part Number)...' : 'Search replacement (by 6-digit Infor Item Number)...';
    
    // Force HTMX to re-process the element with new attributes
    if(window.htmx){
      window.htmx.process(replSearch);
    }
    
    // Always refresh when mode changes; also clear current results immediately for visual feedback
    if(was !== mode){
      replResults.innerHTML = '<div class="small text-muted">Loading '+ (toContract? 'contract' : 'item') +' search...</div>';
      if(window.htmx){
        const q = replSearch.value.trim();
        const url = q ? `${endpoint}?q=${encodeURIComponent(q)}` : endpoint;
        window.htmx.ajax('GET', url, { target: '#repl-results' });
      } else {
        replSearch.dispatchEvent(new Event('keyup'));
      }
    }
  }

  document.addEventListener('click', e => {
    const sentinelBtn = e.target.closest('button[data-sentinel]');
    if(sentinelBtn){
      const code = sentinelBtn.getAttribute('data-sentinel');
      if(code==='NO REPLACEMENT'){
        repls = ['NO REPLACEMENT'];
        document.querySelectorAll('#repl-results input[data-pick-checkbox]').forEach(cb=> cb.checked=false);
        renderSelections();
      }
      return;
    }
  // clear-repl button removed; no action here
    const removeBtn = e.target.closest('[data-remove]');
    if(removeBtn){
      const badge = removeBtn.closest('[data-code]');
      if(badge){
        const code = badge.getAttribute('data-code');
        const kind = badge.getAttribute('data-kind');
        if(kind==='item') items = items.filter(i=>i!==code); else repls = repls.filter(r=>r!==code);
        document.querySelectorAll(`input[data-pick-checkbox][value="${code}"]`).forEach(cb=> cb.checked=false);
        // If a sentinel was removed (kind repl) nothing special needed; stage updates via renderSelections
        renderSelections();
      }
    }
  });

  document.body.addEventListener('htmx:afterSwap', evt => {
    const tgt = evt.target;
    if(tgt.id==='item-results' || tgt.id==='repl-results'){
      const isRepl = tgt.id==='repl-results';
      tgt.querySelectorAll('input[data-pick-checkbox]').forEach(cb => {
        // Re-check if already selected (fresh content)
        if((isRepl? repls: items).includes(cb.value)) cb.checked = true;
        cb.addEventListener('change', () => {
          const code = cb.value;
          const contractId = cb.getAttribute('data-contract-id');
          const mfgPart = cb.getAttribute('data-mfg-part');
          const isPendingPlaceholder = cb.hasAttribute('data-pending-placeholder');
          if(isPendingPlaceholder && /^PENDING\*\*\*/.test(code) && contractId && mfgPart){
            pendingMeta[code] = { contract_id: contractId, mfg_part_num: mfgPart };
          }
          if(isRepl){
            if(cb.checked){
              // If selecting NO REPLACEMENT sentinel
              if(SENTINELS.includes(code)){
                // Uncheck all other checkboxes first to keep UI consistent
                document.querySelectorAll('#repl-results input[data-pick-checkbox]').forEach(other => { if(other!==cb) other.checked=false; });
                repls = [code];
              } else if(/^PENDING\*\*\*/.test(code)) {
                // Dynamic pending placeholder; allow mixing with normal items? Requirement: mixing allowed.
                if(!repls.includes(code)) repls.push(code);
              } else {
                // Block selecting if sentinel already chosen
                if(repls.length===1 && SENTINELS.includes(repls[0])) { cb.checked=false; return; }
                if(!repls.includes(code)) repls.push(code);
              }
            } else {
              repls = repls.filter(c=>c!==code);
            }
            // If in contract mode and code not empty, mirror state across all same-value checkboxes in current result pane
            const currentMode = replSearch.getAttribute('data-mode') || 'item';
            if(currentMode === 'contract' && code){
              // Gather all checkboxes with same value
              const peerCbs = tgt.querySelectorAll(`input[data-pick-checkbox][value="${code}"]`);
              peerCbs.forEach(p => { if(p !== cb) p.checked = cb.checked; });
              // Ensure repls contains (or removes) code exactly once
              if(cb.checked){
                if(SENTINELS.includes(code)) repls = [code];
                else if(!repls.includes(code)) repls.push(code);
              } else {
                repls = repls.filter(r=>r!==code);
              }
            }
          } else {
            if(cb.checked){ if(!items.includes(code)) items.push(code); }
            else { items = items.filter(c=>c!==code); }
          }
          enforceLimits();
          renderSelections();
        });
      });
    }
  });

  createBtn.addEventListener('click', async () => {
    if(createBtn.disabled) return;
    
    // Check per-side limits first
    if(items.length > MAX_PER_SIDE) {
      feedback.innerHTML = `<span class='text-danger'>Too many source items (${items.length}). Max per side: ${MAX_PER_SIDE}</span>`;
      return;
    }
    if(repls.length > MAX_PER_SIDE) {
      feedback.innerHTML = `<span class='text-danger'>Too many replacement items (${repls.length}). Max per side: ${MAX_PER_SIDE}</span>`;
      return;
    }
    
    // Check combination limit
    const totalCombinations = items.length * repls.length;
    if(totalCombinations > MAX_COMBINATIONS) {
      feedback.innerHTML = `<span class='text-danger'>Too many combinations (${totalCombinations}). Max allowed: ${MAX_COMBINATIONS}</span>`;
      return;
    }
    
    const stageDerived = stageBadge.textContent;
    let stageToSend = stageDerived;
    if(stageToSend==='Pending Clinical Approval' && stageSelect.value !== 'Pending Clinical Approval'){
      stageToSend = stageSelect.value; // user override
    }
    const payload = { items, replace_items: repls, stage: stageToSend };
    if(Object.keys(pendingMeta).length){ payload.pending_meta = pendingMeta; }
    const goLive = goLiveInput.value.trim();
    if(goLive) payload.expected_go_live_date = goLive;
    const wrike = wrikeInput.value.trim();
    if(wrike){
      if(!/^\d{10}$/.test(wrike)){
        feedback.innerHTML = `<span class='text-danger'>Wrike Task ID must be 10 digits</span>`;
        return;
      }
      payload.wrike_id = wrike;
    }
    feedback.textContent = 'Creating...';
    try {
      const res = await fetch('/api/item-links/batch', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if(!res.ok){
        feedback.innerHTML = `<span class='text-danger'>Error: ${json.error||'Failed'}</span>`;
      } else {
        feedback.innerHTML = `<span class='text-success'>Created ${json.created}, skipped ${json.skipped.length}, group ${json.group_id}</span>`;
        if(json.records && json.records.length){
          createdWrapper.style.display = '';
          // Append rows
          const rowsHtml = json.records.map(r => {
            const stageBadge = r.stage ? `<span class='badge stage-badge stage-${r.stage.toLowerCase().replace(/ /g,'-')}'>${r.stage}</span>` : '';
            const goLive = r.expected_go_live_date ? r.expected_go_live_date : `<span class='text-muted fst-italic'>unknown</span>`;
            const wrikeDisp = r.wrike_id ? (r.wrike_id.match(/^\d{10}$/) ? `<a href='https://www.wrike.com/open.htm?id=${r.wrike_id}' target='_blank' rel='noopener' class='small'>${r.wrike_id}</a>` : `<span class='text-muted small'>${r.wrike_id}</span>`) : '<span class="text-muted small">—</span>';
            return `<tr>
              <td class='text-center'>
                <button type='button' class='btn btn-sm btn-outline-danger py-0 px-1' title='Remove link' data-remove-link data-item='${r.item}' data-replace-item='${r.replace_item}'>&times;</button>
              </td>
              <td class='text-center fw-semibold'>${r.item_group}</td>
              <td class='font-monospace'>${r.item}</td>
              <td class='font-monospace'>${r.replace_item}</td>
              <td class='text-truncate' style='max-width:140px;' title='${r.mfg_part_num||''}'>${r.mfg_part_num||''}</td>
              <td class='text-truncate' style='max-width:120px;'>${r.manufacturer||''}</td>
              <td class='text-truncate' style='max-width:220px;' title='${r.item_description||''}'>${r.item_description||''}</td>
              <td class='text-truncate' style='max-width:140px;' title='${r.repl_mfg_part_num||''}'>${r.repl_mfg_part_num||''}</td>
              <td class='text-truncate' style='max-width:120px;'>${r.repl_manufacturer||''}</td>
              <td class='text-truncate' style='max-width:220px;' title='${r.repl_item_description||''}'>${r.repl_item_description||''}</td>
              <td class='text-center'>${stageBadge}</td>
              <td>${goLive}</td>
              <td>${wrikeDisp}</td>
              <td class='text-nowrap text-muted' style='font-size:.7rem;'>${r.create_dt ? r.create_dt.substring(0,10):''}</td>
              <td class='text-nowrap text-muted' style='font-size:.7rem;'>${r.update_dt ? r.update_dt.replace('T',' ').substring(0,19):''}</td>
            </tr>`;
          }).join('');
          createdTableBody.insertAdjacentHTML('beforeend', rowsHtml);
          // optional: clear selections after creation
          items = []; repls = [];
          document.querySelectorAll('input[data-pick-checkbox]').forEach(cb=> cb.checked=false);
          renderSelections();
        }
      }
    } catch(err){
      feedback.innerHTML = `<span class='text-danger'>Error: ${err}</span>`;
    }
  });

  // Deletion handler for dynamically added rows
  createdTableBody.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-remove-link]');
    if(!btn) return;
    const item = btn.getAttribute('data-item');
    const replaceItem = btn.getAttribute('data-replace-item');
    if(!item || !replaceItem) return;
    if(!confirm(`Remove link ${item} -> ${replaceItem}?`)) return;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" aria-hidden="true"></span>';
    try {
      const res = await fetch(`/api/item-links/${encodeURIComponent(item)}/${encodeURIComponent(replaceItem)}`, { method: 'DELETE' });
      if(!res.ok){
        const j = await res.json().catch(()=>({}));
        feedback.innerHTML = `<span class='text-danger'>Delete failed: ${j.error||res.status}</span>`;
        btn.disabled = false;
        btn.innerHTML = '&times;';
        return;
      }
      const row = btn.closest('tr');
      row?.remove();
      feedback.innerHTML = `<span class='text-success'>Deleted link ${item} → ${replaceItem}</span>`;
      // Hide wrapper if table now empty
      if(!createdTableBody.querySelector('tr')){
        createdWrapper.style.display = 'none';
      }
    } catch(err){
      feedback.innerHTML = `<span class='text-danger'>Delete error: ${err}</span>`;
      btn.disabled = false;
      btn.innerHTML = '&times;';
    }
  });

  // Toggle button for replacement search mode
  const toggleReplModeBtn = document.getElementById('toggle-repl-mode');
  if(toggleReplModeBtn){
    toggleReplModeBtn.addEventListener('click', () => {
      const currentMode = toggleReplModeBtn.getAttribute('data-mode');
      const newMode = currentMode === 'item' ? 'contract' : 'item';
      
      // 1) Clear current replacement selections
      repls = [];
      document.querySelectorAll('#repl-results input[data-pick-checkbox]').forEach(cb => cb.checked = false);
      
      // 2) Clear the search input
      replSearch.value = '';
      
      // 3) Update button and mode
      toggleReplModeBtn.setAttribute('data-mode', newMode);
      toggleReplModeBtn.textContent = `Mode: ${newMode.charAt(0).toUpperCase() + newMode.slice(1)}`;
      replSearch.setAttribute('data-mode', newMode);
      
      // 4) Switch table display and refresh selections
      updateReplSearchEndpoint();
      renderSelections(); // Update UI to reflect cleared selections

      // 5) Force immediate table refresh with blank query to show correct table headers/structure
      const endpoint = replSearch.getAttribute('hx-get');
      replResults.innerHTML = '<div class="small text-muted">Loading '+ (newMode==='contract' ? 'contract' : 'item') +' search...</div>';
      if(window.htmx){
        window.htmx.ajax('GET', endpoint + '?q=', { target: '#repl-results' });
      } else {
        // Fallback: trigger a synthetic event (will use hx-trigger if supported later)
        replSearch.dispatchEvent(new Event('keyup'));
      }
    });
  }
})();
</script>
{% endblock %}
