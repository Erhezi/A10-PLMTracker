{% extends 'base.html' %}
{% block title %}Conflict Alerts — PLM Tracker{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
	<div>
		<h1 class="h4 fw-semibold mb-1">Conflict Alerts</h1>
		<p class="text-muted small mb-0">Review attempted ItemLink insertions that were rejected by backend validation.</p>
	</div>
	<div class="text-lg-end">
		<span class="badge bg-danger-subtle text-danger fw-semibold me-2">Total logged: {{ total_conflicts }}</span>
		{% for t in error_types %}
			{% set count = type_counts.get(t, 0) %}
			{% if count %}
				<span class="badge bg-secondary-subtle text-secondary fw-semibold me-1">{{ t }}: {{ count }}</span>
			{% endif %}
		{% endfor %}
	</div>
</div>

<form method="get" class="row g-3 align-items-end mb-4">
	<div class="col-md-4 col-lg-3">
		<label for="conflict-type" class="form-label small text-uppercase text-muted">Conflict type</label>
		<select id="conflict-type" name="type" class="form-select form-select-sm">
			<option value="" {% if not selected_type %}selected{% endif %}>All types</option>
			{% for t in error_types %}
				<option value="{{ t }}" {% if selected_type == t %}selected{% endif %}>{{ t|capitalize }}</option>
			{% endfor %}
		</select>
	</div>
	<div class="col-md-3 col-lg-2">
		<label for="conflict-limit" class="form-label small text-uppercase text-muted">Max rows</label>
		<input id="conflict-limit" type="number" name="limit" min="1" max="1000" value="{{ limit }}" class="form-control form-control-sm">
	</div>
	<div class="col-md-3 col-lg-2 d-flex align-items-end gap-2">
		<button type="submit" class="btn btn-primary btn-sm">Apply filters</button>
		<a href="{{ url_for('collector.conflicts') }}" class="btn btn-outline-secondary btn-sm">Reset</a>
	</div>
</form>

{% if conflicts %}
<div class="table-responsive shadow-sm rounded-3 border">
	<table class="table table-sm align-middle mb-0">
		<thead class="table-light text-uppercase small text-muted">
			<tr>
				<th scope="col" style="width: 12rem;">Logged at</th>
				<th scope="col" style="width: 8rem;">Type</th>
				<th scope="col">Source item</th>
				<th scope="col">Replacement</th>
				<th scope="col">Group</th>
				<th scope="col">Details</th>
				<th scope="col" style="width: 6rem;">Link ID</th>
			</tr>
		</thead>
		<tbody>
			{% for conflict in conflicts %}
			<tr>
				<td class="text-nowrap">
					{% if conflict.create_dt %}
						{{ conflict.create_dt.strftime('%Y-%m-%d %H:%M') }}
					{% else %}
						—
					{% endif %}
				</td>
				<td>
					<span class="badge bg-danger-subtle text-danger text-uppercase fw-semibold">{{ conflict.error_type }}</span>
				</td>
				<td class="fw-semibold">{{ conflict.item }}</td>
				<td>
					{% if conflict.replace_item %}
						<div class="fw-semibold">{{ conflict.replace_item }}</div>
					{% else %}
						<span class="text-muted">—</span>
					{% endif %}
				</td>
				<td>
					<span class="badge bg-light text-muted">{{ conflict.item_group }}</span>
				</td>
				<td class="small">{{ conflict.error_message }}</td>
				<td>
					{% if conflict.item_link_id %}
						<span class="badge bg-secondary-subtle text-secondary">#{{ conflict.item_link_id }}</span>
					{% else %}
						<span class="text-muted">—</span>
					{% endif %}
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</div>
<p class="small text-muted mt-2 mb-0">Showing up to {{ limit }} recent entries{% if selected_type %} for type “{{ selected_type }}”{% endif %}.</p>
{% else %}
<div class="alert alert-success border-success-subtle">
	<div class="fw-semibold">All clear!</div>
	<p class="mb-0 small">No conflicts have been recorded yet.</p>
</div>
{% endif %}
{% endblock %}
