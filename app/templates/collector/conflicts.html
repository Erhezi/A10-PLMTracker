{% extends 'base.html' %}
{% block title %}Conflict Alerts — PLM Tracker{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
	<div>
		<h1 class="h4 fw-semibold mb-1 d-flex align-items-center gap-2 flex-wrap">
      <span>
        Conflict Alerts
        <a
          href="{{ url_for('collector.conflict_doc') }}"
          class="text-decoration-none text-accent-pink d-inline-flex align-items-center"
          style="font-size: 0.6em; vertical-align: super; margin-left: 0.25em;"
          title="Open conflict handling documentation"
        >
          <i class="bi bi-info-circle" aria-hidden="true"></i>
          <span class="visually-hidden">Open conflict handling documentation</span>
        </a>
      </span>
    </h1>
		<p class="text-muted small mb-0">Review attempted ItemLink insertions that were rejected by backend validation.</p>
	</div>
	<div class="text-lg-end">
		<span class="badge bg-danger-subtle text-danger fw-semibold me-2">Total logged: {{ total_conflicts }}</span>
		{% for t in error_types %}
			{% set count = type_counts.get(t, 0) %}
			{% if count %}
				<span class="badge bg-secondary-subtle text-secondary fw-semibold me-1">{{ t }}: {{ count }}</span>
			{% endif %}
		{% endfor %}
	</div>
</div>

<div class="row g-3 mb-4 align-items-end">
	<div class="col-lg-8">
		<form method="get" class="row g-3 align-items-end">
			<div class="col-md-5 col-lg-4">
				<label for="conflict-type" class="form-label small text-uppercase text-muted">Conflict type</label>
				<select id="conflict-type" name="type" class="form-select form-select-sm">
					<option value="" {% if not selected_type %}selected{% endif %}>All types</option>
					{% for t in error_types %}
						<option value="{{ t }}" {% if selected_type == t %}selected{% endif %}>{{ t|capitalize }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-md-3 col-lg-3">
				<label for="conflict-limit" class="form-label small text-uppercase text-muted">Max rows</label>
				<input id="conflict-limit" type="number" name="limit" min="1" max="1000" value="{{ limit }}" class="form-control form-control-sm">
			</div>
			<div class="col-md-4 col-lg-5 d-flex align-items-end gap-2">
				<button type="submit" class="btn btn-primary btn-sm">Apply filters</button>
				<a href="{{ url_for('collector.conflicts') }}" class="btn btn-outline-secondary btn-sm">Reset</a>
			</div>
		</form>
	</div>
	<div class="col-lg-4">
		<form method="post" action="{{ url_for('collector.purge_conflicts') }}" class="d-flex flex-column flex-lg-row align-items-lg-end gap-2 justify-content-lg-end">
			<div>
				<label for="purge-date" class="form-label small text-uppercase text-muted">Purge through</label>
				<input id="purge-date" type="date" name="purge_date" class="form-control form-control-sm" min="{{ purge_min_date }}" max="{{ purge_max_date }}" value="{{ purge_max_date }}">
			</div>
			{% if selected_type %}
				<input type="hidden" name="type" value="{{ selected_type }}">
			{% endif %}
			<input type="hidden" name="limit" value="{{ limit }}">
			<button type="submit" class="btn btn-sm btn-outline-danger" title="Deletes conflicts logged before (<) selected date." onclick="return confirm('Purge all conflict records before the selected date? This cannot be undone.');">Purge</button>
		</form>
	</div>
</div>

{% if conflicts %}
<div class="table-responsive shadow-sm rounded-3 border">
	<table class="table table-sm align-middle mb-0">
		<thead class="table-light text-uppercase small text-muted">
			<tr>
				<th scope="col" style="width: 12rem;">Logged at</th>
				<th scope="col" style="width: 8rem;">Type</th>
				<th scope="col">Source item</th>
				<th scope="col">Replacement</th>
				<th scope="col">Group</th>
				<th scope="col">Details</th>
				<th scope="col" style="width: 6rem;">Link ID</th>
				<th scope="col" class="text-end" style="width: 6rem;">Actions</th>
			</tr>
		</thead>
		<tbody>
			{% for conflict in conflicts %}
			<tr>
				<td class="text-nowrap">
					{% if conflict.create_dt %}
						{{ conflict.create_dt.strftime('%Y-%m-%d %H:%M') }}
					{% else %}
						—
					{% endif %}
				</td>
				<td>
					<span class="badge bg-danger-subtle text-danger text-uppercase fw-semibold">{{ conflict.error_type }}</span>
				</td>
				<td class="fw-semibold">{{ conflict.item }}</td>
				<td>
					{% if conflict.replace_item %}
						<div class="fw-semibold">{{ conflict.replace_item }}</div>
					{% else %}
						<span class="text-muted">—</span>
					{% endif %}
				</td>
				<td>
					<span class="badge bg-light text-muted">{{ conflict.item_group }}</span>
				</td>
				<td class="small">{{ conflict.error_message }}</td>
				<td>
					{% if conflict.item_link_id %}
						<span class="badge bg-secondary-subtle text-secondary">#{{ conflict.item_link_id }}</span>
					{% else %}
						<span class="text-muted">—</span>
					{% endif %}
				</td>
				<td class="text-end">
					<form method="post" action="{{ url_for('collector.delete_conflict', pkid=conflict.pkid) }}" class="d-inline">
						{% if selected_type %}
							<input type="hidden" name="type" value="{{ selected_type }}">
						{% endif %}
						<input type="hidden" name="limit" value="{{ limit }}">
						<button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this error entry? This cannot be undone.');">
							<span class="small">Clear</span>
						</button>
					</form>
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</div>
<p class="small text-muted mt-2 mb-0">Showing up to {{ limit }} recent entries{% if selected_type %} for type “{{ selected_type }}”{% endif %}.</p>
{% else %}
<div class="alert alert-success border-success-subtle">
	<div class="fw-semibold">All clear!</div>
	<p class="mb-0 small">No conflicts have been recorded yet.</p>
</div>
{% endif %}
{% endblock %}
