{% extends 'base.html' %}
{% block title %}Dashboard Calculation Guide — PLM Tracker{% endblock %}
{% block content %}
<div class="container py-4">
  <nav aria-label="breadcrumb" class="small mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
      <li class="breadcrumb-item active" aria-current="page">Calculation Guide</li>
    </ol>
  </nav>

  <h1 class="h3 mb-3">Recommended Reorder Policy (BRCalcType: <span class="fw-semibold">simple</span>)</h1>
  <p class="text-muted">The dashboard currently applies the <strong>simple</strong> copy &amp; sum method (<code>BRCalcType = "simple"</code>) to generate recommended setup values for replacement items.</p>
  <ul class="mb-2">
    <li><strong>Assumes replacement usage does not overlap with the source item.</strong></li>
    <li><strong>Replacement items inherit the source item's reorder setup (reorder point, min/max) unless otherwise specified.</strong></li>
  </ul>
  <p class="text-muted">The rules below describe how reorder point, minimum order quantity, and maximum order quantity are derived for each relationship pattern between the source item(s) and the replacement item(s).</p>

  <section class="mt-4">
    <h2 class="h5">Quick Reference Examples</h2>
    <p class="text-muted">Use the sample scenarios below to see the calculations applied end-to-end. All multipliers are whole numbers to mirror real-world UOM configurations.</p>
    <div class="table-responsive quick-ref-table-wrapper">
      <table class="table table-sm table-bordered align-middle mb-0">
        <caption class="visually-hidden">Worked examples for simple burn-rate recommendations</caption>
        <thead class="table-light">
          <tr>
            <th scope="col" style="width: 16%">Relationship</th>
            <th scope="col" style="width: 26%">Source Item Snapshot</th>
            <th scope="col" style="width: 26%">Replacement Snapshot</th>
            <th scope="col" style="width: 32%">Recommended Setup</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">1 &rarr; 1<br><span class="text-muted small">Inventory Location</span></th>
            <td>
              <ul class="mb-0 small">
                <li>Item <code>123</code>, Group <code>234</code>, Location <code>YYY</code></li>
                <li>Reorder Pt: <strong>15</strong>, Min: 3, Max: 30</li>
                <li>Stock UOM: EA (multiplier <strong>1</strong>)</li>
                <li>Buy UOM: BX (multiplier 3)</li>
              </ul>
            </td>
            <td>
              <ul class="mb-0 small">
                <li>Replacement <code>888</code></li>
                <li>Stock UOM: EA (multiplier <strong>1</strong>)</li>
                <li>Buy UOM: BX (multiplier <strong>8</strong>)</li>
              </ul>
            </td>
            <td>
              <ul class="mb-0 small">
                <li>Reorder Pt: <strong>15</strong> (ceil(15 &times; 1 &div; 1))</li>
                <li>Min Order: <strong>8</strong> (replacement buy multiplier)</li>
                <li>Max Order: <strong>32</strong> (round-half-up(30 &div; 8) &times; 8)</li>
              </ul>
            </td>
          </tr>
          <tr>
            <th scope="row">1 &rarr; 1<br><span class="text-muted small">Par Location</span></th>
            <td>
              <ul class="mb-0 small">
                <li>Item <code>2201</code>, Group <code>445</code>, Location <code>PAR-01</code></li>
                <li>Reorder Pt: <strong>15</strong>, Min: 0, Max: 0</li>
                <li>Stock multiplier: <strong>4</strong></li>
              </ul>
            </td>
            <td>
              <ul class="mb-0 small">
                <li>Replacement <code>2201R</code></li>
                <li>Stock multiplier: <strong>3</strong></li>
                <li>Transaction multiplier: <strong>6</strong></li>
              </ul>
            </td>
            <td>
              <ul class="mb-0 small">
                <li>Reorder Pt: <strong>20</strong> (ceil(15 &times; 4 &div; 3))</li>
                <li>Min Order: <strong>0</strong> (source min)</li>
                <li>Max Order: <strong>0</strong> (round-half-up(0 &times; 4 &div; 6))</li>
              </ul>
            </td>
          </tr>
          <tr>
            <th scope="row">Many &rarr; 1<br><span class="text-muted small">Inventory Location</span></th>
            <td>
              <ul class="mb-0 small">
                <li>Sources: <code>SRC-1</code>, <code>SRC-2</code> (group <code>404</code>)</li>
                <li>Reorder Pts: 10 &amp; 15 with stock multipliers <strong>8</strong></li>
                <li>Max Orders: 5 &amp; 4 (same multipliers)</li>
              </ul>
            </td>
            <td>
              <ul class="mb-0 small">
                <li>Replacement <code>REPL-404</code></li>
                <li>Stock multiplier: <strong>5</strong></li>
                <li>Buy multiplier: <strong>6</strong></li>
              </ul>
            </td>
            <td>
              <ul class="mb-0 small">
                <li>Reorder Pt: <strong>40</strong> (ceil((10&times;8 + 15&times;8) &div; 5))</li>
                <li>Min Order: <strong>6</strong> (replacement buy multiplier)</li>
                <li>Max Order: <strong>72</strong> (round-half-up((5&times;8 + 4&times;8) &div; 6) &times; 6)</li>
              </ul>
            </td>
          </tr>
          <tr>
            <th scope="row">1 &rarr; Many<br><span class="text-muted small">Inventory Location</span></th>
            <td>
              <ul class="mb-0 small">
                <li>Item <code>606</code>, Location <code>LOC-1M</code></li>
                <li>Reorder Pt: <strong>24</strong>, Min: 12, Max: 48</li>
                <li>Stock multiplier: <strong>4</strong></li>
              </ul>
            </td>
            <td>
              <ul class="mb-0 small">
                <li>Replacement <code>REPL-A</code>: stock mult <strong>3</strong>, buy mult <strong>6</strong></li>
                <li>Replacement <code>REPL-B</code>: stock mult <strong>2</strong>, buy mult <strong>9</strong></li>
              </ul>
            </td>
            <td>
              <ul class="mb-0 small">
                <li><code>REPL-A</code> reorder <strong>16</strong>, min <strong>6</strong>, max <strong>96</strong></li>
                <li><code>REPL-B</code> reorder <strong>24</strong>, min <strong>9</strong>, max <strong>99</strong></li>
                <li>Even split: fraction = 1 &div; 2</li>
              </ul>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="mt-4">
    <h2 class="h5">1. One Source &rarr; One Replacement</h2>
    <div class="row g-4">
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Inventory Locations</h3>
          <ul class="mb-0">
            <li><strong>Min Order Qty</strong> = replacement buy UOM multiplier.</li>
            <li><strong>Reorder Point</strong> = ceil&lpar;source reorder point &times; source stock UOM multiplier &div; replacement stock UOM multiplier&rpar;.</li>
            <li><strong>Max Order Qty</strong> = round-half-up&lpar;source max order qty &times; source stock UOM multiplier &div; replacement buy UOM multiplier&rpar; &times; replacement buy UOM multiplier.</li>
          </ul>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Par Locations</h3>
          <ul class="mb-0">
            <li><strong>Min Order Qty</strong> = source min order qty.</li>
            <li><strong>Reorder Point</strong> = ceil&lpar;source reorder point &times; source stock UOM multiplier &div; replacement stock UOM multiplier&rpar;.</li>
            <li><strong>Max Order Qty</strong> = round-half-up&lpar;source max order qty &times; source stock UOM multiplier &div; replacement transaction UOM multiplier&rpar;.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="mt-5">
    <h2 class="h5">2. Many Sources &rarr; One Replacement</h2>
    <p class="text-muted">When multiple source items roll into a single replacement, the source values are first translated into EA using the stock UOM multipliers, summed, and then re-scaled into the replacement units.</p>
    <div class="row g-4">
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Inventory Locations</h3>
          <ul class="mb-0">
            <li><strong>Min Order Qty</strong> = replacement buy UOM multiplier.</li>
            <li><strong>Reorder Point</strong> = ceil&lpar;Σ[source reorder point &times; source stock UOM multiplier] &div; replacement stock UOM multiplier&rpar;.</li>
            <li><strong>Max Order Qty</strong> = round-half-up&lpar;Σ[source max order qty &times; source stock UOM multiplier] &div; replacement buy UOM multiplier&rpar; &times; replacement buy UOM multiplier.</li>
          </ul>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Par Locations</h3>
          <ul class="mb-0">
            <li><strong>Min Order Qty</strong> = max positive source min order qty.</li>
            <li><strong>Reorder Point</strong> = ceil&lpar;Σ[source reorder point &times; source stock UOM multiplier] &div; replacement stock UOM multiplier&rpar;.</li>
            <li><strong>Max Order Qty</strong> = round-half-up&lpar;Σ[source max order qty &times; source stock UOM multiplier] &div; replacement transaction UOM multiplier&rpar;.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="mt-5">
    <h2 class="h5">3. One Source &rarr; Many Replacements</h2>
    <p class="text-muted">A distribution fraction of <code>1 / count(replacements)</code> is applied to the source volumes. Future updates may allow custom fractions, but the <strong>simple</strong> calculation assumes an even split.</p>
    <div class="row g-4">
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Inventory Locations</h3>
          <ul class="mb-0">
            <li><strong>Min Order Qty</strong> = replacement buy UOM multiplier.</li>
            <li><strong>Reorder Point</strong> = round-half-up&lpar;source reorder point &times; source stock UOM multiplier &times; fraction &div; replacement stock UOM multiplier&rpar;.</li>
            <li><strong>Max Order Qty</strong> = round-half-up&lpar;source max order qty &times; source stock UOM multiplier &times; fraction &div; replacement buy UOM multiplier&rpar; &times; replacement buy UOM multiplier.</li>
          </ul>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Par Locations</h3>
          <ul class="mb-0">
            <li><strong>Min Order Qty</strong> = source min order qty.</li>
            <li><strong>Reorder Point</strong> = ceil&lpar;source reorder point &times; source stock UOM multiplier &times; fraction &div; replacement stock UOM multiplier&rpar;.</li>
            <li><strong>Max Order Qty</strong> = round-half-up&lpar;source max order qty &times; source stock UOM multiplier &times; fraction &div; replacement transaction UOM multiplier&rpar;.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="mt-5">
    <h2 class="h5">Burn Rate Fallbacks &amp; Notes</h2>
    <ul>
      <li>If a required multiplier is missing or non-positive, the calculator falls back to the best available source values without changing sign.</li>
      <li>The output keeps whole numbers when possible; all rounding uses "round half up" unless otherwise noted.</li>
      <li>The documentation will expand as new <code>BRCalcType</code> strategies are introduced.</li>
    </ul>
  </section>

  <section id="inventory-setup-export" class="mt-5">
    <h2 class="h4 mb-3">Inventory Setup Export</h2>
    <p class="text-muted mb-3">
      Dashboard &rarr; Inventory Locations &rarr; Export exposes the <strong>Inventory setup</strong> mode. The export route
      (<code>@dashboard.export_table("inventory")</code> in <code>app/dashboard/routes.py</code>) reuses the same
      <code>_filtered_inventory_rows</code> helper that powers the on-screen table, so every filter (stage, tri-state toggles,
      quantity thresholds, search) applies before the workbook is assembled.
    </p>
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Pipeline</h3>
          <ol class="small mb-0">
            <li><strong>Row gathering.</strong> <code>build_location_pairs</code> queries PLM Tracker base views with <code>include_par=False</code> and optional OR filtering. The helper keeps both source (<code>*_ri</code>) and replacement columns in each row.</li>
            <li><strong>Stage &amp; attribute filters.</strong> Tri-state helpers such as <code>_apply_tri_state_filter</code> and <code>_apply_quantity_filter</code> strip rows that do not match the UI toggles. Stage filters default to <code>PLMTrackerBase</code> values <em>Pending Clinical Readiness</em>, <em>Tracking - Item Transition</em>, and <em>Tracking - Discontinued</em>.</li>
            <li><strong>Setup classification.</strong> Every remaining row is passed through <code>assign_setup_action(table="inventory")</code>, which calls <code>derive_setup_action</code> / <code>should_mark_update_as_no_action</code> to convert backend <code>action</code> flags into <em>Add</em>, <em>Replace</em>, or <em>No Action (U)</em>.</li>
            <li><strong>Export mode.</strong> Selecting <em>Inventory setup</em> attaches the <code>inventory_setup</code> <code>ColumnMode</code> defined in <code>app/export/modes.py</code>. Its pipeline applies <code>prepare_inventory_setup_rows</code>, <code>apply_setup_action_rules(table="inventory")</code>, and <code>sort_export_rows("inventory_setup")</code>.</li>
            <li><strong>Workbook rendering.</strong> The ordered rows plus <code>INVENTORY_EXPORT_COLUMNS</code> (or a filtered subset) are sent to <code>render_workbook</code>, which enforces header overrides, freeze panes, auto-filters, width heuristics, and row highlighting.</li>
          </ol>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Highlight &amp; headers</h3>
          <ul class="small mb-0">
            <li><strong>Header overrides.</strong> <code>INVENTORY_SETUP_HEADER_OVERRIDES</code> remaps column names to Lawson-friendly titles (for example, <code>recommended_preferred_bin_ri</code> becomes <em>PreferredBin</em>).</li>
            <li><strong>Recommended bins.</strong> <code>apply_inventory_recommended_bin_display</code> recalculates <em>Preferred Bin (Recom.)</em> using <code>compute_inventory_recommended_preferred_bin</code> so blank values emit TBD instead of <code>N/A</code>.</li>
            <li><strong>Highlighting.</strong> The <code>_inventory_setup_should_highlight</code> predicate only shades rows whose recommended bin is not <em>NEW ITEM</em>. Combined with <code>highlight_notes=True</code>, this matches the legacy Lawson review sheet where actionable rows are pink.</li>
            <li><strong>Sorting.</strong> Rows are grouped by <code>(company, location_ri, recommended_preferred_bin_ri)</code> via <code>sort_export_rows</code> to minimize bin shuffling for the same inventory location.</li>
          </ul>
        </div>
      </div>
    </div>
    <p class="small text-muted mt-3 mb-0">
      The entire export stack is unit-tested through <code>tests/test_export_workbook.py</code> and the dashboard API tests.
      Those suites assert that requested column subsets, highlight rules, and setup actions remain stable as new attributes are added.
    </p>
  </section>

  <section id="par-setup-export" class="mt-5">
    <h2 class="h4 mb-3">PAR Setup Export</h2>
    <p class="text-muted mb-3">
      Choosing <strong>PAR setup &rpar; combined</strong> in the export modal activates the <code>par_setup_combined</code>
      column mode. The upstream data is produced by <code>_filtered_par_rows</code> with <code>include_par=True</code> and
      location type restricted to <em>Par Location</em>. After filters are applied the logic mirrors inventory, but with
      PAR-specific calculations (for example, <code>weeks_reorder</code> derivations executed in <code>_filtered_par_rows</code>).
    </p>
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Replacement rows</h3>
          <ul class="small mb-0">
            <li><strong>Action cleanup.</strong> <code>apply_setup_action_rules(table="par", forced_item_set="Replacement")</code> removes muted entries and normalizes <em>Add/Replace</em> labels.</li>
            <li><strong>Quantities.</strong> <code>prepare_par_setup_combined_rows</code> keeps Lawson-ready min/max/reorder values
              (<code>recommended_*_ri</code>) alongside current state columns for comparison.</li>
            <li><strong>Highlight predicate.</strong> The combined export highlights rows whose <code>item_set</code> equals <em>Replacement</em>, signaling to the PAR team which rows require inventory location updates.</li>
          </ul>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="border rounded p-3 h-100">
          <h3 class="h6 text-uppercase text-muted">Original rows</h3>
          <ul class="small mb-0">
            <li><strong>Preferred bin synthesis.</strong> <code>prepare_par_setup_original_rows</code> builds sequential <em>Now*</em> bin labels via the <code>_letter_suffix</code> helper to keep duplicates unique inside Lawson's 10-character constraint.</li>
            <li><strong>Forced Replace.</strong> Original-side entries are emitted with <code>setup_action="Replace"</code> so downstream consumers always treat them as retirements once the replacement goes live.</li>
            <li><strong>Combined ordering.</strong> The final list is sorted by company, inventory location, and recommended bin to keep mirrored replacement/original rows adjacent.</li>
          </ul>
        </div>
      </div>
    </div>
    <p class="small text-muted mt-3">
      Additional PAR-specific modes (<code>par_setup_replacement</code>, <code>par_setup_original</code>) can still be selected for single-sided workflows.
      All three modes share the same <code>render_workbook</code> engine, so update cadence and formatting stay consistent with the Inventory export.
    </p>
  </section>
</div>
{% endblock %}
