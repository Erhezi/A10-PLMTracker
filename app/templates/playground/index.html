{% extends "base.html" %}

{% block title %}Playground Â· PLM Tracker{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title text-primary fw-semibold">Playground</h5>
        <p class="card-text small text-muted mb-3">
          Experimental visual sandbox for exploring replacement relationships. This view pulls a recent
          slice of <code>ItemLink</code> pairs and lays them out as a playful, force-directed galaxy.
        </p>
        <dl class="row small mb-0">
          <dt class="col-6 text-muted">Rendered nodes</dt>
          <dd class="col-6">{{ summary.rendered_nodes }}</dd>
          <dt class="col-6 text-muted">Rendered links</dt>
          <dd class="col-6">{{ summary.rendered_links }}</dd>
          <dt class="col-6 text-muted">Stage filter</dt>
          <dd class="col-6">
            {% if summary.selected_stages %}
              {{ summary.selected_stages | join(', ') }}
            {% else %}
              All stages
            {% endif %}
          </dd>
          <dt class="col-6 text-muted">Search filter</dt>
          <dd class="col-6">
            {% if summary.search_query %}
              "{{ summary.search_query }}"
            {% else %}
              None
            {% endif %}
          </dd>
        </dl>
        <hr />
        <form method="get" class="small mb-3">
          {% if summary.explicit_limit %}
          <input type="hidden" name="limit" value="{{ summary.explicit_limit }}" />
          {% endif %}
          <label class="form-label text-muted text-uppercase fw-semibold" style="letter-spacing: 0.08em; font-size: 0.7rem;">Search items</label>
          <input type="search" name="search" value="{{ search_query }}" class="form-control form-control-sm mb-3" placeholder="Manufacturer, item, or description" />
          <label class="form-label text-muted text-uppercase fw-semibold" style="letter-spacing: 0.08em; font-size: 0.7rem;">Filter by stage</label>
          <div class="border rounded-3 p-2 bg-light-subtle overflow-auto" style="max-height: 220px;">
            {% if stages %}
              {% for stage in stages %}
              <div class="form-check mb-1">
                <input class="form-check-input" type="checkbox" name="stage" value="{{ stage }}" id="stage-{{ loop.index }}" {% if stage in selected_stages %}checked{% endif %}>
                <label class="form-check-label" for="stage-{{ loop.index }}">{{ stage }}</label>
              </div>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0">No stage values detected.</p>
            {% endif %}
          </div>
          <div class="d-flex align-items-center gap-2 mt-3">
            <button class="btn btn-primary btn-sm" type="submit">Apply filters</button>
            {% if selected_stages %}
            <a class="btn btn-link btn-sm text-decoration-none" href="{{ url_for('playground.index') }}">Clear</a>
            {% endif %}
          </div>
        </form>
        <hr class="my-4" />
        <div class="form-check form-switch small">
          <input class="form-check-input" type="checkbox" role="switch" id="toggle-node-labels">
          <label class="form-check-label" for="toggle-node-labels">Show item numbers on nodes</label>
        </div>
        <p class="small text-muted mb-0">
          Want to tweak density? Add <code>?limit=800</code> to the URL (max 1500). We skip placeholders and
          "NO REPLACEMENT" entries to keep things tidy.
        </p>
      </div>
    </div>
  </div>
    <div class="col-12 col-xl-9">
            <div class="card border-0 shadow-sm">
              <div class="card-body p-0">
                <div class="playground-visual-stack d-flex flex-column flex-lg-row align-items-stretch">
                  <div id="playground-graph" class="playground-graph flex-grow-1 position-relative" style="min-height: 600px;"></div>
                  <div class="playground-legend-wrapper border-top border-lg-top-0 border-lg-start">
                    <div class="playground-legend-shell">
                      <div id="playground-legend" class="d-flex flex-column" style="max-height: 600px;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://d3js.org/d3.v7.min.js" defer></script>
  <script id="playground-data" type="application/json">
    {{ graph_data | tojson(indent=2) }}
  </script>
  <script src="{{ url_for('static', filename='js/playground-graph.js') }}" defer></script>
{% endblock %}
