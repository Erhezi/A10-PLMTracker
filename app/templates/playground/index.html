{% extends "base.html" %}

{% block title %}Playground Â· PLM Tracker{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap mb-3">
          <h5 class="card-title text-primary fw-semibold mb-0">Playground</h5>
          <div class="form-check form-switch small ms-auto me-1">
            <input class="form-check-input" type="checkbox" id="toggle-animation" checked>
            <label class="form-check-label" for="toggle-animation">Animate layout</label>
          </div>
        </div>
        <p class="card-text small text-muted mb-3">
          Experimental visual sandbox for exploring replacement relationships. This view pulls a recent
          slice of <code>ItemLink</code> pairs and lays them out as a playful, force-directed graph.
          'Pending Item Number' pairs are excluded from this view.
        </p>
        <dl class="row small mb-0">
          <dt class="col-6 text-muted">Rendered nodes</dt>
          <dd class="col-6">{{ summary.rendered_nodes }}</dd>
          <dt class="col-6 text-muted">Rendered links</dt>
          <dd class="col-6">{{ summary.rendered_links }}</dd>
          <dt class="col-6 text-muted">Stage filter</dt>
          <dd class="col-6">
            {% if summary.selected_stages %}
              {{ summary.selected_stages | join(', ') }}
            {% else %}
              {% if summary.expanded_scope %}
                All stages
              {% else %}
                Transition stages
              {% endif %}
            {% endif %}
          </dd>
          <dt class="col-6 text-muted">Search filter</dt>
          <dd class="col-6">
            {% if summary.search_query %}
              "{{ summary.search_query }}"
            {% else %}
              None
            {% endif %}
          </dd>
          <dt class="col-6 text-muted">Inventory location</dt>
          <dd class="col-6">
            {% if summary.apply_quantity %}
              {% if summary.selected_inventory_location_label %}
                {{ summary.selected_inventory_location_label }}
              {% elif summary.selected_inventory_location %}
                {{ summary.selected_inventory_location }}
              {% else %}
                (location not selected)
              {% endif %}
            {% else %}
              Not applied
            {% endif %}
          </dd>
        </dl>
        <hr />
        <form method="get" class="small mb-3">
          {% if summary.explicit_limit %}
          <input type="hidden" name="limit" value="{{ summary.explicit_limit }}" />
          {% endif %}
          <input type="hidden" name="apply_quantity" value="{{ 1 if apply_quantity else 0 }}" id="hidden-apply-quantity" />
          <input type="hidden" name="inventory_location" value="{{ selected_inventory_location or '' }}" id="hidden-inventory-location" />
          <label class="form-label text-muted text-uppercase fw-semibold" style="letter-spacing: 0.08em; font-size: 0.7rem;">Search items</label>
          <input type="search" name="search" value="{{ search_query }}" class="form-control form-control-sm mb-3" placeholder="Manufacturer, item, or description" />
          <div class="form-check form-switch small mb-2">
            <input class="form-check-input" type="checkbox" id="toggle-expanded-scope" name="expanded" value="1" {% if expanded_scope %}checked{% endif %} {% if apply_quantity %}disabled{% endif %}>
            <label class="form-check-label" for="toggle-expanded-scope">Include all stages</label>
          </div>
          <p class="small text-muted mb-3">Adds Tracking Completed and Deleted; excludes Pending Item Number rows.</p>
          <label class="form-label text-muted text-uppercase fw-semibold" style="letter-spacing: 0.08em; font-size: 0.7rem;">Filter by stage</label>
          <div class="border rounded-3 p-2 bg-light-subtle overflow-auto" style="max-height: 220px;">
            {% if stages %}
              {% for stage in stages %}
              <div class="form-check mb-1">
                <input class="form-check-input" type="checkbox" name="stage" value="{{ stage }}" id="stage-{{ loop.index }}" {% if selected_stages %}{% if stage in selected_stages %}checked{% endif %}{% else %}checked{% endif %}>
                <label class="form-check-label" for="stage-{{ loop.index }}">{{ stage }} ({{ stage_counts.get(stage, 0) }})</label>
              </div>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0">No stage values detected.</p>
            {% endif %}
          </div>
          <div class="d-flex align-items-center gap-2 mt-3">
            <button class="btn btn-primary btn-sm" type="submit">Apply filters</button>
            {% if selected_stages %}
            <a class="btn btn-link btn-sm text-decoration-none" href="{% if expanded_scope %}{{ url_for('playground.index', expanded=1) }}{% else %}{{ url_for('playground.index') }}{% endif %}">Clear</a>
            {% endif %}
          </div>
        </form>
        <hr class="my-4" />
        <div class="form-check form-switch small">
          <input class="form-check-input" type="checkbox" role="switch" id="toggle-node-labels">
          <label class="form-check-label" for="toggle-node-labels">Show item numbers on nodes</label>
        </div>
        <div class="form-check form-switch small mt-3">
          <input class="form-check-input" type="checkbox" role="switch" id="toggle-apply-quantity" {% if apply_quantity %}checked{% endif %}>
          <label class="form-check-label" for="toggle-apply-quantity">Apply available quantity</label>
        </div>
        <div id="inventory-location-controls" class="mt-3 {% if not apply_quantity %}d-none{% endif %}">
          <label class="form-label text-muted text-uppercase fw-semibold" for="inventory-location-select" style="letter-spacing: 0.08em; font-size: 0.7rem;">Inventory location</label>
          <select class="form-select form-select-sm" id="inventory-location-select">
            <option value="">Select a location</option>
            {% for option in inventory_locations %}
            <option value="{{ option.value }}" {% if option.value == selected_inventory_location %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
          </select>
          <p class="small text-muted mt-2 mb-0">When enabled, node size reflects ItemLocations.AvailableQty at the selected location and temporarily disables the 'Include all stages' scope.</p>
        </div>
      </div>
    </div>
  </div>
    <div class="col-12 col-xl-9">
            <div class="card border-0 shadow-sm">
              <div class="card-body p-0">
                <div class="playground-visual-stack d-flex flex-column flex-lg-row align-items-stretch">
                  <div id="playground-graph" class="playground-graph flex-grow-1 position-relative" style="min-height: 600px;"></div>
                  <div class="playground-legend-wrapper border-top border-lg-top-0 border-lg-start">
                    <div class="playground-legend-shell">
                      <div id="playground-legend" class="d-flex flex-column" style="max-height: 600px;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://d3js.org/d3.v7.min.js" defer></script>
  <script id="playground-data" type="application/json">
    {{ graph_data | tojson(indent=2) }}
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const scopeToggle = document.getElementById("toggle-expanded-scope");
      const scopeForm = scopeToggle ? scopeToggle.closest("form") : null;
      if (!scopeForm) {
        return;
      }

  const stageInputs = Array.from(scopeForm.querySelectorAll('input[name="stage"]'));
  const originalStageDisabledState = new Map(stageInputs.map((input) => [input, input.disabled]));
      const applyQuantityToggle = document.getElementById("toggle-apply-quantity");
      const locationControls = document.getElementById("inventory-location-controls");
      const locationSelect = document.getElementById("inventory-location-select");
      const hiddenApplyQuantity = document.getElementById("hidden-apply-quantity");
      const hiddenLocation = document.getElementById("hidden-inventory-location");

      function setHiddenApplyQuantity(enabled) {
        if (hiddenApplyQuantity) {
          hiddenApplyQuantity.value = enabled ? "1" : "0";
        }
      }

      function setHiddenLocation(value) {
        if (hiddenLocation) {
          hiddenLocation.value = value || "";
        }
      }

      function applyScopeState(options = {}) {
        if (!scopeToggle) {
          return;
        }
        const { checkAllStages = false, disableStageInputs } = options;
        if (checkAllStages) {
          stageInputs.forEach((input) => {
            input.checked = true;
          });
        }
        stageInputs.forEach((input) => {
          if (typeof disableStageInputs === "boolean") {
            input.disabled = disableStageInputs;
          } else if (originalStageDisabledState.has(input)) {
            input.disabled = originalStageDisabledState.get(input);
          }
        });
      }

      function syncQuantityUI(shouldSubmit = false) {
        const enabled = Boolean(applyQuantityToggle && applyQuantityToggle.checked);
        setHiddenApplyQuantity(enabled);

        if (scopeToggle) {
          scopeToggle.disabled = enabled;
          if (enabled) {
            scopeToggle.checked = false;
          }
        }

        if (locationControls) {
          locationControls.classList.toggle("d-none", !enabled);
        }

        if (locationSelect) {
          if (enabled && !locationSelect.value) {
            const firstOption = Array.from(locationSelect.options).find((option) => option.value);
            if (firstOption) {
              locationSelect.value = firstOption.value;
            }
          }
          setHiddenLocation(locationSelect.value);
        } else {
          setHiddenLocation("");
        }

  applyScopeState({ checkAllStages: false, disableStageInputs: false });

        if (shouldSubmit) {
          scopeForm.requestSubmit();
        }
      }

      if (scopeToggle) {
        scopeToggle.addEventListener("change", function () {
          applyScopeState({ checkAllStages: scopeToggle.checked });
          scopeForm.requestSubmit();
        });
      }

      if (applyQuantityToggle) {
        applyQuantityToggle.addEventListener("change", function () {
          syncQuantityUI(true);
        });
      }

      if (locationSelect) {
        locationSelect.addEventListener("change", function () {
          setHiddenLocation(locationSelect.value);
          if (applyQuantityToggle && applyQuantityToggle.checked) {
            scopeForm.requestSubmit();
          }
        });
      }

      syncQuantityUI(false);
      applyScopeState({ checkAllStages: scopeToggle && scopeToggle.checked, disableStageInputs: false });
    });
  </script>
  <script src="{{ url_for('static', filename='js/playground-graph.js') }}" defer></script>
{% endblock %}
